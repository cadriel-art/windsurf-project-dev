function $(e){return document.getElementById(e)}function downloadJson(e,t){const n=JSON.stringify(t,null,2),a=new Blob([n],{type:"application/json"}),o=URL.createObjectURL(a),s=document.createElement("a");s.href=o,s.download=e,s.click(),URL.revokeObjectURL(o)}function debounce(e,t){let n;return function(...a){clearTimeout(n),n=setTimeout(()=>{clearTimeout(n),e(...a)},t)}}const debouncedSave=debounce(()=>{window.SiteTemplate?.saveConfig&&(window.SiteTemplate.saveConfig({mode:"draft"}),setStatus("Auto-saved","good"))},2e3);function renderBackups(){const e=$("backups");if(!e)return;if(!window.SiteTemplate?.listBackups)return;const t=SiteTemplate.listBackups();e.innerHTML="",t.forEach(t=>{const n=document.createElement("div");n.className="list-item";const a=document.createElement("div");a.className="list-meta";const o=document.createElement("div");o.className="list-title",o.textContent=t.label?`${t.label}`:t.id;const s=document.createElement("div");s.className="list-sub";const r=t.createdAt?new Date(t.createdAt).toLocaleString():"";s.textContent=`${r} • ${t.mode||"draft"}`,a.append(o,s);const i=document.createElement("div");i.className="media-actions";const c=document.createElement("button");c.className="btn mini",c.type="button",c.textContent="Restore → Draft";const d=document.createElement("button");d.className="btn mini",d.type="button",d.textContent="Restore → Live";const l=document.createElement("button");l.className="btn mini",l.type="button",l.textContent="Export Backup";const u=document.createElement("button");u.className="btn danger mini",u.type="button",u.textContent="Delete",c.addEventListener("click",()=>{try{SiteTemplate.restoreBackup(t.id,{mode:"draft"}),setStatus("Restored into Draft."),renderBackups()}catch{setStatus("Restore failed.","error")}}),d.addEventListener("click",()=>{try{SiteTemplate.restoreBackup(t.id,{mode:"live"}),setStatus("Restored into Live."),renderBackups()}catch{setStatus("Restore failed.","error")}}),l.addEventListener("click",()=>{downloadJson(`backup-${t.id}.json`,t),setStatus("Backup exported.")}),u.addEventListener("click",()=>{SiteTemplate.deleteBackup(t.id),renderBackups(),setStatus("Backup deleted.")}),i.append(c,d,l,u),n.append(a,i),e.appendChild(n)})}function sectionLabel(e){return"hero"===e?"Hero":"projects"===e?"Projects":"contact"===e?"Contact":"footer"===e?"Footer":e}function renderHomeBuilder(e,t){const n=$("homeBuilder");if(!n)return;const a=Array.isArray(e?.homeLayout?.sections)?e.homeLayout.sections:[{id:"hero",enabled:!0},{id:"projects",enabled:!0},{id:"contact",enabled:!0},{id:"footer",enabled:!0}];function o(n){const a=clone(e);a.homeLayout=a.homeLayout||{},a.homeLayout.sections=n,t(a)}n.innerHTML="",a.forEach((e,t)=>{const s=document.createElement("div");s.className="list-item";const r=document.createElement("div");r.className="list-meta";const i=document.createElement("div");i.className="list-title",i.textContent=sectionLabel(e.id);const c=document.createElement("div");c.className="list-sub",c.textContent=e.enabled?"enabled":"disabled",r.append(i,c);const d=document.createElement("div");d.className="media-actions";const l=document.createElement("button");l.className="btn mini",l.type="button",l.textContent=e.enabled?"Disable":"Enable";const u=document.createElement("button");u.className="btn mini",u.type="button",u.textContent="Up",u.disabled=0===t;const m=document.createElement("button");m.className="btn mini",m.type="button",m.textContent="Down",m.disabled=t===a.length-1,l.addEventListener("click",()=>{o(a.map((e,n)=>n===t?{...e,enabled:!e.enabled}:e))}),u.addEventListener("click",()=>{const e=a.slice(),n=e[t-1];e[t-1]=e[t],e[t]=n,o(e)}),m.addEventListener("click",()=>{const e=a.slice(),n=e[t+1];e[t+1]=e[t],e[t]=n,o(e)}),d.append(l,u,m),s.append(r,d),n.appendChild(s)})}function renderSeoEditor(e,t){const n=$("seoMetaTitle"),a=$("seoMetaDescription"),o=$("seoOgImage"),s=$("seoFavicon");if(!(n&&a&&o&&s))return;const r=e?.seo||{};n.value="string"==typeof r.metaTitle?r.metaTitle:"",a.value="string"==typeof r.metaDescription?r.metaDescription:"";const i=Array.isArray(e?.mediaLibrary)?e.mediaLibrary:[];function c(e,t){e.innerHTML="";const n=document.createElement("option");n.value="",n.textContent="(none)",e.appendChild(n),i.forEach(t=>{const n=document.createElement("option");n.value=t.id,n.textContent=t.name||t.id,e.appendChild(n)}),e.value=t&&i.some(e=>e.id===t)?t:""}function d(n){const a=clone(e);a.seo=a.seo||{},a.seo={...a.seo,...n},t(a)}c(o,r.ogImageAssetId),c(s,r.faviconAssetId),n.dataset.bound||(n.dataset.bound="1",n.addEventListener("input",()=>d({metaTitle:n.value}))),a.dataset.bound||(a.dataset.bound="1",a.addEventListener("input",()=>d({metaDescription:a.value}))),o.dataset.bound||(o.dataset.bound="1",o.addEventListener("change",()=>d({ogImageAssetId:o.value}))),s.dataset.bound||(s.dataset.bound="1",s.addEventListener("change",()=>d({faviconAssetId:s.value})))}function renderMenuPrimary(e,t){const n=$("menuPrimary");if(!n)return;const a=Array.isArray(e?.menu?.primary)?e.menu.primary:[];n.innerHTML="",a.forEach((o,s)=>{const r=document.createElement("div");r.className="row";const i=document.createElement("select");[{v:"page",t:"Page"},{v:"anchor",t:"Anchor"},{v:"url",t:"External URL"}].forEach(e=>{const t=document.createElement("option");t.value=e.v,t.textContent=e.t,i.appendChild(t)}),i.value=o?.type||"page";const c=document.createElement("input");c.value=o?.label||"";const d=document.createElement("input");function l(n){const a=clone(e);a.menu=a.menu||{};const o=Array.isArray(a.menu.primary)?a.menu.primary.slice():[];o[s]=n,a.menu.primary=o,t(a)}function u(){const e=i.value,t=c.value;return"page"===e?{type:"page",slug:slugify(d.value||"home")||"home",label:t||"Page"}:"anchor"===e?{type:"anchor",href:d.value||"#",label:t||"Anchor"}:{type:"url",href:d.value||"https://",label:t||"Link"}}function m(e,t,n){const a=document.createElement("label");n&&(a.className=n);const o=document.createElement("span");return o.textContent=e,a.append(o,t),a}"page"===i.value?(d.placeholder="page slug (e.g. about)",d.value=o?.slug||"home"):(d.placeholder="anchor"===i.value?"#section":"https://example.com",d.value=o?.href||""),i.addEventListener("change",()=>{"page"===i.value?(d.placeholder="page slug (e.g. about)",d.value="home"):(d.placeholder="anchor"===i.value?"#section":"https://example.com",d.value=""),l(u())}),c.addEventListener("input",()=>l(u())),d.addEventListener("input",()=>l(u())),r.append(m("Type",i),m("Label",c,"col-2"),m("page"===i.value?"Slug":"Href",d,"col-3"));const p=document.createElement("div");p.className="row-actions";const v=document.createElement("div");v.className="pill",v.textContent=`#${s+1}`;const g=document.createElement("button");g.className="btn mini",g.type="button",g.textContent="Up",g.disabled=0===s;const f=document.createElement("button");f.className="btn mini",f.type="button",f.textContent="Down",f.disabled=s===a.length-1;const b=document.createElement("button");b.className="btn danger mini",b.type="button",b.textContent="Remove",g.addEventListener("click",()=>{const n=clone(e);n.menu=n.menu||{};const o=a.slice(),r=o[s-1];o[s-1]=o[s],o[s]=r,n.menu.primary=o,t(n)}),f.addEventListener("click",()=>{const n=clone(e);n.menu=n.menu||{};const o=a.slice(),r=o[s+1];o[s+1]=o[s],o[s]=r,n.menu.primary=o,t(n)}),b.addEventListener("click",()=>{const n=clone(e);n.menu=n.menu||{},n.menu.primary=a.filter((e,t)=>t!==s),t(n)}),p.append(v,g,f,b),r.appendChild(p),n.appendChild(r)})}function setStatus(e,t){const n=$("status");n&&(n.textContent=e,n.dataset.type=t||"info")}function renderDiagnostics(e){const t=$("diagnostics");if(!t)return;const n=[];function a(e,t,a){const o=null==t?"":String(t);n.push(`<span class="diag-pill ${a||""}"><strong>${e}:</strong> ${o}</span>`)}a("Mode",e.mode,""),a("Storage",e.storageKey,""),a("State",e.saveState,e.saveStateClass),e.lastSaved&&a("Last Saved",e.lastSaved,"good"),e.lastError&&a("Error",e.lastError,"bad"),t.innerHTML=`<div class="row">${n.join(" ")}</div>`}function safeJsonParse(e){try{return JSON.parse(e)}catch{return null}}async function readFileAsText(e){return e.text()}function clone(e){return"function"==typeof structuredClone?structuredClone(e):JSON.parse(JSON.stringify(e))}function debounce(e,t){let n;return function(...a){n&&window.clearTimeout(n),n=window.setTimeout(()=>e.apply(this,a),t)}}function readFileAsDataUrl(e){return new Promise((t,n)=>{const a=new FileReader;a.onload=()=>t(String(a.result||"")),a.onerror=()=>n(new Error("file-read-failed")),a.readAsDataURL(e)})}function formatBytes(e){const t=Number(e||0);if(!t)return"0 B";const n=["B","KB","MB","GB"];let a=0,o=t;for(;o>=1024&&a<n.length-1;)o/=1024,a+=1;return`${o.toFixed(0===a?0:1)} ${n[a]}`}async function copyToClipboard(e){try{return await navigator.clipboard.writeText(e),!0}catch{return!1}}function renderMediaLibrary(e,t){const n=$("mediaLibrary");if(!n)return;const a=Array.isArray(e?.mediaLibrary)?e.mediaLibrary:[];n.innerHTML="",a.forEach(a=>{const o=document.createElement("div");o.className="media-item";const s=document.createElement("div");if(s.className="media-thumb",a?.dataUrl){const e=document.createElement("img");e.src=a.dataUrl,e.alt=a.name||"Media",s.appendChild(e)}const r=document.createElement("div"),i=document.createElement("div");i.className="media-meta";const c=document.createElement("div");c.className="media-name",c.textContent=a?.name||a?.id||"Untitled";const d=document.createElement("div");d.className="media-sub",d.textContent=`${formatBytes(a?.size)} • ${a?.type||"image"}`,i.append(c,d);const l=document.createElement("div");l.className="media-actions";const u=document.createElement("button");u.className="btn mini",u.type="button",u.textContent="Use as Logo";const m=document.createElement("button");m.className="btn mini",m.type="button",m.textContent="Use as Avatar";const p=document.createElement("button");p.className="btn mini",p.type="button",p.textContent="Copy Data URL";const v=document.createElement("button");function g(e){t(e)}v.className="btn danger mini",v.type="button",v.textContent="Delete",u.addEventListener("click",()=>{const t=clone(e);t.media=t.media||{},t.media.logoDataUrl=a.dataUrl||"",g(t),setStatus("Logo set from library.")}),m.addEventListener("click",()=>{const t=clone(e);t.media=t.media||{},t.media.avatarDataUrl=a.dataUrl||"",g(t),setStatus("Avatar set from library.")}),p.addEventListener("click",async()=>{if(!a?.dataUrl)return;const e=await copyToClipboard(a.dataUrl);setStatus(e?"Copied.":"Copy failed.",e?"info":"error")}),v.addEventListener("click",()=>{const t=clone(e);t.mediaLibrary=(Array.isArray(t.mediaLibrary)?t.mediaLibrary:[]).filter(e=>e?.id!==a.id),g(t),setStatus("Deleted media item.")}),l.append(u,m,p,v),r.append(i,l),o.append(s,r),n.appendChild(o)})}function normalizeTags(e){return e.split(",").map(e=>e.trim()).filter(Boolean)}function slugify(e){return String(e||"").toLowerCase().trim().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"").slice(0,60)}function ensureUniqueSlug(e,t,n){const a=slugify(t)||"page";let o=a,s=2;const r=new Set((Array.isArray(e)?e:[]).filter(e=>e&&e.id!==n).map(e=>String(e.slug||"").toLowerCase()));for(;r.has(o);)o=`${a}-${s}`,s+=1;return o}function getSelectedPageId(){return window.__selectedPageId||"home"}function setSelectedPageId(e){window.__selectedPageId=e}function getSelectedPage(e){const t=Array.isArray(e?.pages)?e.pages:[],n=getSelectedPageId();return t.find(e=>e?.id===n)||t[0]||null}function renderPages(e,t){const n=$("pages");if(!n)return;const a=Array.isArray(e?.pages)?e.pages:[];a.length?(a.some(e=>e?.id===getSelectedPageId())||setSelectedPageId(a[0].id),n.innerHTML="",a.forEach(a=>{const o=document.createElement("div");o.className="list-item",a.id===getSelectedPageId()&&o.classList.add("active");const s=document.createElement("div");s.className="list-meta";const r=document.createElement("div");r.className="list-title",r.textContent=a.title||a.slug||a.id;const i=document.createElement("div");i.className="list-sub",i.textContent=`/${a.slug} • ${a.template||"blocks"}`,s.append(r,i);const c=document.createElement("button");c.className="btn mini",c.type="button",c.textContent="Edit",c.addEventListener("click",()=>{setSelectedPageId(a.id),renderPages(e,t),renderPageEditor(e,t)}),o.append(s,c),n.appendChild(o)})):n.innerHTML=""}function renderBlocksEditor(e,t,n){const a=$("blocks");if(!a)return;a.innerHTML="";const o=Array.isArray(e?.blocks)?e.blocks:[];o.forEach((s,r)=>{const i=document.createElement("div");i.className="row";const c=document.createElement("textarea");c.rows=6,c.value=String(s?.html||"");const d=document.createElement("div");d.className="row-actions";const l=document.createElement("div");l.className="pill",l.textContent=`Block #${r+1} • richText`;const u=document.createElement("button");u.className="btn mini",u.type="button",u.textContent="Up",u.disabled=0===r;const m=document.createElement("button");m.className="btn mini",m.type="button",m.textContent="Down",m.disabled=r===o.length-1;const p=document.createElement("button");function v(a){const o=clone(t),s=Array.isArray(o.pages)?o.pages:[],r=s.findIndex(t=>t?.id===e.id);-1!==r&&(s[r]={...s[r],blocks:a},o.pages=s,n(o))}p.className="btn danger mini",p.type="button",p.textContent="Remove",c.addEventListener("input",()=>{v(o.map((e,t)=>t===r?{type:"richText",html:c.value}:e))}),u.addEventListener("click",()=>{const e=o.slice(),t=e[r-1];e[r-1]=e[r],e[r]=t,v(e)}),m.addEventListener("click",()=>{const e=o.slice(),t=e[r+1];e[r+1]=e[r],e[r]=t,v(e)}),p.addEventListener("click",()=>{v(o.filter((e,t)=>t!==r))}),d.append(l,u,m,p),i.appendChild(c),i.appendChild(d),a.appendChild(i)})}function renderPageEditor(e,t){const n=$("pageTitle"),a=$("pageSlug"),o=$("pageTemplate");if(!n||!a||!o)return;const s=getSelectedPage(e);function r(n){const a=clone(e),o=Array.isArray(a.pages)?a.pages:[],r=o.findIndex(e=>e?.id===s.id);-1!==r&&(o[r]={...o[r],...n},a.pages=o,t(a))}s&&(n.value=s.title||"",a.value=s.slug||"",o.value=s.template||"blocks",renderBlocksEditor(s,e,t),n.dataset.boundPages||(n.dataset.boundPages="1",n.addEventListener("input",()=>{r({title:n.value})})),a.dataset.boundPages||(a.dataset.boundPages="1",a.addEventListener("input",()=>{const t=getSelectedPage(e),n=ensureUniqueSlug(Array.isArray(e?.pages)?e.pages:[],a.value,t?.id);a.value!==n&&(a.value=n),r({slug:n})})),o.dataset.boundPages||(o.dataset.boundPages="1",o.addEventListener("change",()=>{r({template:o.value})})))}function projectRow(e,t,n,a,o,s,r){const i=document.createElement("div");i.className="row";const c=document.createElement("input");c.value=e.category||"";const d=document.createElement("input");d.value=e.appType||"";const l=document.createElement("input");l.value=e.title||"";const u=document.createElement("select");["electric","fire","water","alien"].forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,u.appendChild(t)}),u.value=e.base||"electric";const m=document.createElement("input");m.value=Array.isArray(e.tags)?e.tags.join(", "):"";const p=document.createElement("textarea");p.rows=3,p.value=e.description||"";const v=document.createElement("textarea");v.rows=2,v.placeholder="https://example.com\nhttps://github.com/project",v.value=Array.isArray(e.links)?e.links.join("\n"):"";const g=document.createElement("select");g.innerHTML='<option value="">None</option>',Array.isArray(n)&&n.forEach(e=>{const t=document.createElement("option");t.value=e.id,t.textContent=e.name||e.id,g.appendChild(t)}),g.value=e.featuredImage||"";const f=document.createElement("input");function b(e,t,n){const a=document.createElement("label");n&&(a.className=n);const o=document.createElement("span");return o.textContent=e,a.append(o,t),a}f.type="checkbox",f.checked=e.hidden||!1,i.append(b("Category",c),b("Type",d),b("Title",l,"col-2"),b("Element",u),b("Tags (comma)",m,"col-2"),b("Description",p,"col-6"),b("Links (newline)",v,"col-3"),b("Featured Image",g,"col-2"),b("Hidden",f));const h=document.createElement("div");h.className="row-actions";const y=document.createElement("div");y.className="pill",y.textContent=`#${t+1}`;const E=document.createElement("button");E.className="btn mini",E.type="button",E.textContent="Up",E.disabled=0===t;const S=document.createElement("button");S.className="btn mini",S.type="button",S.textContent="Down",S.disabled=t===r-1;const L=document.createElement("button");function T(){a(t,{category:c.value,appType:d.value,title:l.value,description:p.value,base:u.value,tags:normalizeTags(m.value),links:v.value.split("\n").map(e=>e.trim()).filter(Boolean),featuredImage:g.value,hidden:f.checked})}return L.className="btn danger",L.type="button",L.textContent="Remove",L.addEventListener("click",()=>o(t)),h.append(y,E,S,L),i.appendChild(h),[c,d,l,p,u,m,v,g,f].forEach(e=>e.addEventListener("input",T)),g.addEventListener("change",T),f.addEventListener("change",T),E.addEventListener("click",()=>s(t,"up")),S.addEventListener("click",()=>s(t,"down")),i}function renderProjects(e,t){const n=$("projects");if(!n)return;n.innerHTML="";const a=Array.isArray(e.projects)?e.projects:[],o=Array.isArray(e.mediaLibrary)?e.mediaLibrary:[];function s(n,a){const o=clone(e),s=o.projects.slice();"up"===a&&n>0?[s[n-1],s[n]]=[s[n],s[n-1]]:"down"===a&&n<s.length-1&&([s[n+1],s[n]]=[s[n],s[n+1]]),o.projects=s,t(o)}a.forEach((r,i)=>{const c=projectRow(r,i,o,(n,a)=>{const o=clone(e);o.projects[n]=a,t(o)},n=>{const a=clone(e);a.projects.splice(n,1),t(a)},s,a.length);n.appendChild(c)})}function getActiveTheme(e){const t=e.activeThemeId||"default";return e.themePresets||(e.themePresets={}),e.themePresets[t]||(e.themePresets[t]={name:t,theme:{}}),e.themePresets[t].theme}function renderThemeColors(e,t){const n=$("themeColors");if(!n)return;n.innerHTML="";const a=getActiveTheme(e);["electric","fire","water","alien"].forEach(o=>{const s=a.colors?.[o]||{};["background","text","accent"].forEach(a=>{const r=document.createElement("label");r.innerHTML=`\n        <span>${o} ${a}</span>\n        <input type="color" value="${s[a]||"#000000"}" />\n      `;const i=r.querySelector("input");i.addEventListener("change",()=>{const n=clone(e),s=getActiveTheme(n);s.colors||(s.colors={}),s.colors[o]||(s.colors[o]={}),s.colors[o][a]=i.value,t(n)}),n.appendChild(r)})})}function bindBasics(e,t){const n=$("logoText"),a=$("siteTitle"),o=$("themePreset"),s=$("duplicateTheme"),r=$("logoUpload"),i=$("avatarUpload"),c=$("heroHeadline"),d=$("heroTyping"),l=$("heroDescription"),u=$("contactTitle"),m=$("contactSubtitle"),p=$("contactEmail"),v=$("footerText"),g=$("socialGithub"),f=$("socialLinkedIn"),b=$("socialTwitter"),h=$("themeFontFamily"),y=$("themeFontSize");function E(){const s=e();if(!s)return;n&&(n.value=s.brand?.logoText||""),a&&(a.value=s.brand?.siteTitle||""),c&&(c.value=s.hero?.headline||""),d&&(d.value=s.hero?.typingText||""),l&&(l.value=s.hero?.description||""),u&&(u.value=s.contact?.title||""),m&&(m.value=s.contact?.subtitle||""),p&&(u.value=s.contact?.email||""),v&&(v.value=s.footer?.text||""),g&&(g.value=s.social?.github||""),f&&(f.value=s.social?.linkedin||""),b&&(b.value=s.social?.twitter||"");const r=getActiveTheme(s);h&&(h.value=r.fontFamily||""),y&&(y.value=r.fontSize||16),renderThemeColors(s,t),function(e){if(!o)return;o.innerHTML="";const t=e?.themePresets&&"object"==typeof e.themePresets?e.themePresets:{};Object.entries(t).forEach(([e,t])=>{const n=document.createElement("option");n.value=e,n.textContent=t?.name?String(t.name):e,o.appendChild(n)});const n=e?.activeThemeId||"default";o.value=t[n]?n:"default"}(s)}function S(){const o=e();if(!o)return;const s=clone(o);s.brand.logoText=n?.value||"",s.brand.siteTitle=a?.value||"",s.hero.headline=c?.value||"",s.hero.typingText=d?.value||"",s.hero.description=l?.value||"",s.contact.title=u?.value||"",s.contact.subtitle=m?.value||"",s.contact.email=p?.value||"",s.footer=s.footer||{},s.footer.text=v?.value||"",s.social=s.social||{},s.social.github=g?.value||"",s.social.linkedin=f?.value||"",s.social.twitter=b?.value||"",t(s)}o&&!o.dataset.bound&&(o.dataset.bound="1",o.addEventListener("change",()=>{const n=e();if(!n)return;const a=clone(n);a.activeThemeId=o.value,t(a),E()})),s&&!s.dataset.bound&&(s.dataset.bound="1",s.addEventListener("click",()=>{const n=e();if(!n)return;const a=clone(n),o=a.activeThemeId||"default",s=a?.themePresets?.[o]?.theme||{},r=`custom-${Date.now()}`;a.themePresets&&"object"==typeof a.themePresets||(a.themePresets={}),a.themePresets[r]={name:"Custom Copy",theme:clone(s)},a.activeThemeId=r,t(a),setStatus("Theme duplicated."),E()})),r&&!r.dataset.bound&&(r.dataset.bound="1",r.addEventListener("change",async n=>{const a=n.target.files?.[0];if(a)try{const n=await readFileAsDataUrl(a),o=e();if(!o)return;const s=clone(o);s.media=s.media||{},s.media.logoDataUrl=n,t(s),setStatus("Logo updated.")}catch{setStatus("Could not read image.","error")}finally{n.target.value=""}})),i&&!i.dataset.bound&&(i.dataset.bound="1",i.addEventListener("change",async n=>{const a=n.target.files?.[0];if(a)try{const n=await readFileAsDataUrl(a),o=e();if(!o)return;const s=clone(o);s.media=s.media||{},s.media.avatarDataUrl=n,t(s),setStatus("Avatar updated.")}catch{setStatus("Could not read image.","error")}finally{n.target.value=""}})),[n,a,c,d,l,u,m,p,v,g,f,b].forEach(e=>{e&&(e.dataset.bound||(e.dataset.bound="1",e.addEventListener("input",S)))}),h&&!h.dataset.bound&&(h.dataset.bound="1",h.addEventListener("input",()=>{const e=clone(config);getActiveTheme(e).fontFamily=h.value,t(e)})),y&&!y.dataset.bound&&(y.dataset.bound="1",y.addEventListener("input",()=>{const e=clone(config);getActiveTheme(e).fontSize=parseInt(y.value)||16,t(e)})),E()}function init(){const e="draft",t={mode:e,storageKey:"",saveState:"Idle",saveStateClass:"",lastSaved:"",lastError:""};function n(e){t.lastError=String(e&&e.message?e.message:e),t.saveState="Error",t.saveStateClass="bad",renderDiagnostics(t)}function a(e,n){t.saveState=e,t.saveStateClass=n||"",renderDiagnostics(t)}if(window.addEventListener("error",e=>{n(e?.error||e?.message||"Runtime error")}),window.addEventListener("unhandledrejection",e=>{n(e?.reason||"Unhandled promise rejection")}),!window.SiteTemplate)return t.storageKey="(SiteTemplate missing)",n(new Error("SiteTemplate not loaded")),void setStatus("Admin scripts failed to load.","error");let o;t.storageKey=SiteTemplate.STORAGE_KEY_DRAFT,renderDiagnostics(t);try{o=SiteTemplate.loadConfig({mode:e})}catch(e){return n(e),void setStatus("Could not load config.","error")}let s=!1,r=[],i=[];const c=$("undo"),d=$("redo");function l(){c&&(c.disabled=0===r.length),d&&(d.disabled=0===i.length)}const u=debounce(o=>{try{a("Saving…","warn"),SiteTemplate.saveConfig(o,{mode:e}),t.lastSaved=(new Date).toLocaleTimeString(),t.lastError="",a("Saved","good"),setStatus("Saved.")}catch(e){n(e),setStatus("Save failed.","error")}},350);function m(e){const t=e;s||(r.push(clone(o)),r.length>50&&(r=r.slice(r.length-50)),i=[]),a("Unsaved","warn"),o=t,bindBasics(()=>o,m),renderPages(o,m),renderPageEditor(o,m),renderMenuPrimary(o,m),renderMediaLibrary(o,m),renderSeoEditor(o,m),renderHomeBuilder(o,m),renderProjects(o,m),$("rawJson").value=JSON.stringify(o,null,2),l(),u(o)}bindBasics(()=>o,m),renderPages(o,m),renderPageEditor(o,m),renderMenuPrimary(o,m),renderMediaLibrary(o,m),renderSeoEditor(o,m),renderHomeBuilder(o,m),renderProjects(o,m),$("rawJson").value=JSON.stringify(o,null,2);const p=$("addPage");p&&!p.dataset.bound&&(p.dataset.bound="1",p.addEventListener("click",()=>{const e=clone(o),t=Array.isArray(e.pages)?e.pages:[],n=`page-${Date.now()}`,a=ensureUniqueSlug(t,"page",n);t.push({id:n,slug:a,title:"New Page",template:"blocks",blocks:[{type:"richText",html:"<h2>New Page</h2><p>Edit me.</p>"}]}),e.pages=t,setSelectedPageId(n),m(e),setStatus("Page added.")}));const v=$("deletePage");v&&!v.dataset.bound&&(v.dataset.bound="1",v.addEventListener("click",()=>{const e=getSelectedPage(o);if(!e)return;if("home"===e.id)return void setStatus("Home page cannot be deleted.","error");const t=clone(o);t.pages=(Array.isArray(t.pages)?t.pages:[]).filter(t=>t?.id!==e.id),setSelectedPageId("home"),m(t),setStatus("Page deleted.")}));const g=$("addBlock");g&&!g.dataset.bound&&(g.dataset.bound="1",g.addEventListener("click",()=>{const e=getSelectedPage(o);if(!e)return;if("home"===e.template)return void setStatus("Home template does not use blocks.","error");const t=clone(o),n=Array.isArray(t.pages)?t.pages:[],a=n.findIndex(t=>t?.id===e.id);if(-1===a)return;const s=Array.isArray(n[a].blocks)?n[a].blocks.slice():[];s.push({type:"richText",html:"<h2>Section</h2><p>New content…</p>"}),n[a]={...n[a],blocks:s},t.pages=n,m(t),setStatus("Block added.")}));const f=$("addMenuItem");f&&!f.dataset.bound&&(f.dataset.bound="1",f.addEventListener("click",()=>{const e=clone(o);e.menu=e.menu||{};const t=Array.isArray(e.menu.primary)?e.menu.primary.slice():[];t.push({type:"page",slug:"home",label:"Home"}),e.menu.primary=t,m(e),setStatus("Menu item added.")}));const b=$("mediaUpload");b&&!b.dataset.bound&&(b.dataset.bound="1",b.addEventListener("change",async e=>{const t=e.target.files?.[0];if(t){t.size>5242880&&setStatus("File is larger than 5MB, may affect performance.","warn");try{const e=await readFileAsDataUrl(t),n=clone(o),a=Array.isArray(n.mediaLibrary)?n.mediaLibrary.slice():[];a.unshift({id:`asset-${Date.now()}`,name:t.name,type:t.type,size:t.size,dataUrl:e,createdAt:(new Date).toISOString()}),n.mediaLibrary=a,m(n),setStatus("Uploaded to media library.")}catch{setStatus("Upload failed.","error")}finally{e.target.value=""}}}));const h=$("backupDraft");h&&!h.dataset.bound&&(h.dataset.bound="1",h.addEventListener("click",()=>{try{SiteTemplate.createBackup({mode:"draft",label:"Draft"}),renderBackups(),setStatus("Draft backup created.")}catch{setStatus("Backup failed.","error")}}));const y=$("backupLive");y&&!y.dataset.bound&&(y.dataset.bound="1",y.addEventListener("click",()=>{try{SiteTemplate.createBackup({mode:"live",label:"Live"}),renderBackups(),setStatus("Live backup created.")}catch{setStatus("Backup failed.","error")}}));const E=$("exportDraft");E&&!E.dataset.bound&&(E.dataset.bound="1",E.addEventListener("click",()=>{downloadJson("site-config.draft.json",SiteTemplate.loadConfig({mode:"draft"})),setStatus("Draft exported.")}));const S=$("exportLive");S&&!S.dataset.bound&&(S.dataset.bound="1",S.addEventListener("click",()=>{downloadJson("site-config.live.json",SiteTemplate.loadConfig({mode:"live"})),setStatus("Live exported.")}));const L=$("importDraft");L&&!L.dataset.bound&&(L.dataset.bound="1",L.addEventListener("change",async e=>{const t=e.target.files?.[0];if(t)try{const e=safeJsonParse(await readFileAsText(t));if(!e)return void setStatus("Invalid JSON file.","error");SiteTemplate.saveConfig(e,{mode:"draft"}),setStatus("Imported into Draft."),renderBackups()}catch{setStatus("Import failed.","error")}finally{e.target.value=""}}));const T=$("importLive");T&&!T.dataset.bound&&(T.dataset.bound="1",T.addEventListener("change",async e=>{const t=e.target.files?.[0];if(t)try{const e=safeJsonParse(await readFileAsText(t));if(!e)return void setStatus("Invalid JSON file.","error");SiteTemplate.saveConfig(e,{mode:"live"}),setStatus("Imported into Live."),renderBackups()}catch{setStatus("Import failed.","error")}finally{e.target.value=""}})),$("addProject").addEventListener("click",()=>{const e=clone(o);e.projects.push({category:"New",appType:"",title:"Untitled",description:"",tags:[],base:"electric",links:[],featuredImage:"",hidden:!1}),m(e)}),$("applyJson").addEventListener("click",()=>{const e=safeJsonParse($("rawJson").value);e?m(e):setStatus("Invalid JSON.","error")}),c&&c.addEventListener("click",()=>{if(!r.length)return;i.push(clone(o));const t=r.pop();o=t,s=!0,SiteTemplate.saveConfig(o,{mode:e}),s=!1,bindBasics(()=>o,m),renderProjects(o,m),$("rawJson").value=JSON.stringify(o,null,2),l(),setStatus("Undo.")}),d&&d.addEventListener("click",()=>{if(!i.length)return;r.push(clone(o));const t=i.pop();o=t,s=!0,SiteTemplate.saveConfig(o,{mode:e}),s=!1,bindBasics(()=>o,m),renderProjects(o,m),$("rawJson").value=JSON.stringify(o,null,2),l(),setStatus("Redo.")}),$("reset").addEventListener("click",()=>{SiteTemplate.resetConfig({mode:e}),o=SiteTemplate.loadConfig({mode:e}),bindBasics(()=>o,m),renderProjects(o,m),$("rawJson").value=JSON.stringify(o,null,2),a("Unsaved","warn"),setStatus("Reset to defaults.")});const k=$("resetLive");k&&!k.dataset.bound&&(k.dataset.bound="1",k.addEventListener("click",()=>{SiteTemplate.resetConfig({mode:"live"}),setStatus("Live reset to defaults.")}));const C=$("saveNow");C&&C.addEventListener("click",()=>{try{a("Saving…","warn"),SiteTemplate.saveConfig(o,{mode:e}),t.lastSaved=(new Date).toLocaleTimeString(),t.lastError="",a("Saved","good"),setStatus("Saved.")}catch(e){n(e),setStatus("Save failed.","error")}});const w=$("publish");w&&w.addEventListener("click",()=>{try{SiteTemplate.publishDraft(),setStatus("Published to live.")}catch{setStatus("Publish failed.","error")}}),$("export").addEventListener("click",()=>{const e=JSON.stringify(o,null,2),t=new Blob([e],{type:"application/json"}),n=URL.createObjectURL(t),a=document.createElement("a");a.href=n,a.download="site-config.json",a.click(),URL.revokeObjectURL(n),setStatus("Exported.")}),$("import").addEventListener("change",async e=>{const t=e.target.files?.[0];if(!t)return;const n=safeJsonParse(await t.text());if(!n)return setStatus("Invalid JSON file.","error"),void(e.target.value="");m(n),e.target.value="",setStatus("Imported.")}),SiteTemplate.subscribe(e=>{s=!0,o=e,bindBasics(()=>o,m),renderPages(o,m),renderPageEditor(o,m),renderMenuPrimary(o,m),renderMediaLibrary(o,m),renderSeoEditor(o,m),renderHomeBuilder(o,m),renderProjects(o,m),$("rawJson").value=JSON.stringify(o,null,2),s=!1,l(),t.lastError="",a("Synced","good"),setStatus("Updated from another tab.")},{mode:e}),renderBackups(),l(),a("Saved","good")}document.addEventListener("DOMContentLoaded",init),document.addEventListener("input",e=>{e.target.matches("input, textarea, select")&&debouncedSave()});